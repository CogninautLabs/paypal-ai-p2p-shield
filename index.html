<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="AI-powered PayPal P2P scam shield. 100% on-device, offline, instant." />
  <title>PayPal AI P2P Shield</title>
  <link rel="manifest" href="manifest.json" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline';
    connect-src 'self';
    img-src 'self' data:;
  ">

  <style>
    :root {
      --bg: #001f3f; --card: #003087; --input: #002b5c; --text: #fff;
      --accent: #0070ba; --danger: #ff4136; --safe: #66ff99; --warn: #ffdd57;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 1rem; line-height: 1.6; }
    .container { max-width: 960px; margin: 0 auto; }
    header { text-align: center; padding: 2rem 0; }
    h1 { color: #00ccff; font-size: 2.2rem; font-weight: 600; }
    .tagline { font-size: 1.1rem; opacity: 0.9; margin-top: 0.5rem; }
    .card { background: var(--card); padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .card h2 { color: #00ccff; margin-top: 0; font-weight: 500; }
    #noteInput { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid #00509e; border-radius: 8px; background: var(--input); color: var(--text); transition: border 0.2s; }
    #noteInput:focus { outline: none; border-color: #00ccff; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    button { background: var(--accent); color: white; border: none; padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s; }
    button:hover { background: #005ea6; }
    button.danger { background: var(--danger); }
    button.danger:hover { background: #cc2d26; }
    #result { margin-top: 1rem; padding: 1rem; border-radius: 8px; font-weight: 600; min-height: 3.5rem; transition: all 0.3s ease; }
    .status { font-size: 1.1rem; margin: 0; }
    .meta { font-size: 0.9rem; opacity: 0.9; margin: 0.25rem 0 0; }
    .footer { text-align: center; font-size: 0.85rem; color: #aaa; margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid #004a8c; }
    a { color: #00ccff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    @media (prefers-color-scheme: light) {
      :root { --bg: #f8f9fa; --card: #ffffff; --input: #f1f3f5; --text: #212529; }
      body { background: var(--bg); color: var(--text); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PayPal AI P2P Shield</h1>
      <p class="tagline">Offline AI scam detection — 12 KB model, 30ms inference</p>
    </header>

    <div class="card">
      <h2>Scan Payment Note</h2>
      <p>Try: <code>mom sick $300 urgent</code> | <code>coffee $10 thanks</code></p>
      <div class="input-group">
        <input id="noteInput" placeholder="Enter note..." aria-label="PayPal note" autocomplete="off" />
        <div class="btn-group">
          <button onclick="example(true)">Scam</button>
          <button onclick="example(false)">Safe</button>
          <button class="danger" id="flag" style="display:none" onclick="flag()">Flag Scam</button>
        </div>
      </div>
      <div id="result" role="alert" aria-live="polite">Enter a note.</div>
    </div>

    <div class="card">
      <p><strong>By:</strong> <a href="https://cogninautlabs.com" target="_blank">Cogninaut Labs</a></p>
      <p>100% on-device. No data sent. Works offline.</p>
    </div>

    <div class="footer">
      <p>© 2025 Cogninaut Labs | v3.0 Perfect | Quantized 12 KB Model</p>
    </div>
  </div>

  <!-- WASM + TF.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@4.10.0/dist/tf-wasm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3"></script>

  <script>
    const $ = id => document.getElementById(id);
    const input = $('noteInput'), result = $('result'), flag = $('flag');
    let use, model, ready = false, timer;

    const CONFIG = { THRESHOLD: 68, DEBOUNCE: 280 };
    const CACHE = 'p2p_shield_v3';

    // Levenshtein for fuzzy match
    const lev = (a, b) => {
      const m = [];
      for (let i = 0; i <= b.length; i++) { m[i] = [i]; }
      for (let j = 0; j <= a.length; j++) { m[0][j] = j; }
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          m[i][j] = b[i-1] === a[j-1] ? m[i-1][j-1] : Math.min(m[i-1][j-1] + 1, m[i][j-1] + 1, m[i-1][j] + 1);
        }
      }
      return m[b.length][a.length];
    };

    const fuzzy = (text, word) => {
      const clean = text.toLowerCase().replace(/0/g,'o').replace(/1/g,'i').replace(/[^a-z]/g,'');
      return clean.includes(word) || lev(clean, word) <= 2;
    };

    const rules = text => {
      let score = 0;
      const lower = text.toLowerCase();
      if (/\$\d{2,}|\d{2,}\s*(usd|eur|gbp)|\b(100|[2-9]\d{2,})\b/i.test(text)) score += 34;
      if (/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}]/u.test(text)) score += 23;
      const trig = ['urgent','now','asap','pls','mom','dad','sick','gift','refund','oops'];
      trig.forEach(w => { if (fuzzy(lower, w)) score += 11; });
      return Math.min(score, 90);
    };

    const load = async () => {
      if (ready) return;
      result.innerHTML = '<p>Loading 12 KB model…</p>'; result.style.background = '#002b5c';
      await tf.setBackend('wasm');
      await tf.ready();
      use = await use.load();
      model = await tf.loadLayersModel('model/model.json');
      ready = true;
      localStorage.setItem(CACHE, '1');
      result.innerHTML = '<p style="color:#66ff99;">Shield active.</p>';
    };

    const scan = async () => {
      const text = input.value.trim();
      if (!text) { result.innerHTML = 'Enter a note.'; result.style.background = '#334466'; flag.style.display='none'; return; }

      const r = rules(text);
      if (r > 80) { blocked(r, 'Rules'); return; }

      result.innerHTML = '<p>AI thinking…</p>'; result.style.background = '#002b5c';
      await load();

      let ai = r;
      try {
        const emb = await use.embed([text]);
        const pred = model.predict(emb);
        ai = Math.round(pred.dataSync()[0] * 100);
      } catch (e) { console.warn(e); }

      const final = Math.max(r, ai);
      final > CONFIG.THRESHOLD ? blocked(final, ai > r ? 'AI' : 'Rules+AI') : clear(final);
    };

    const blocked = (risk, src) => {
      result.style.background = '#440000';
      result.innerHTML = `<p class="status" style="color:#ff4136;">BLOCKED – ${risk}% RISK</p>
        <p class="meta"><strong>Source:</strong> ${src}</p>
        <p class="meta">Verify sender. Do not send.</p>`;
      flag.style.display = 'inline-block';
    };

    const clear = risk => {
      result.style.background = '#003300';
      result.innerHTML = `<p class="status" style="color:#66ff99;">CLEAR – ${risk}% RISK</p>
        <p class="meta">No threats detected.</p>`;
      flag.style.display = 'none';
    };

    const debounce = (fn, d) => { return (...a) => { clearTimeout(timer); timer = setTimeout(() => fn(...a), d); }; };
    input.addEventListener('input', debounce(scan, CONFIG.DEBOUNCE));

    window.example = scam => {
      input.value = scam ? 'mom in hospital need $300 urgent' : 'thanks for the $10 coffee';
      scan();
    };

    window.flag = () => {
      const flags = JSON.parse(localStorage.getItem('flags') || '[]');
      flags.push({text: input.value, time: Date.now()});
      localStorage.setItem('flags', JSON.stringify(flags.slice(-100)));
      alert('Flagged. Thank you.');
    };

    // Init
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
    if (localStorage.getItem(CACHE)) load().catch(() => {});
  </script>
</body>
</html>
